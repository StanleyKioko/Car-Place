<!DOCTYPE html>
<html lang="en">
<!-- Keep existing head content -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blobe Cars - Buy Your Dream Car</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    .car-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .car-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    .hero-bg {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?q=80&w=1000&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
    }
    #featuredCarsLoadingSpinner {
      display: flex;
      justify-content: center;
      padding: 2rem;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #3b82f6;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Image Gallery Styles */
    .car-image-gallery {
      position: relative;
      overflow: hidden;
      height: 200px;
    }
    
    .gallery-images {
      display: flex;
      transition: transform 0.3s ease;
      height: 100%;
    }
    
    .gallery-image {
      min-width: 100%;
      object-fit: cover;
      height: 100%;
    }
    
    .gallery-nav {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .car-image-gallery:hover .gallery-nav {
      opacity: 1;
    }
    
    .gallery-btn {
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 0 8px;
      transition: background 0.2s;
    }
    
    .gallery-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    
    .gallery-indicators {
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    
    .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      cursor: pointer;
    }
    
    .indicator.active {
      background: #ffffff;
    }
  </style>
</head>
<!-- Keep existing body content until the script part -->
<body class="bg-gray-100">
  <!-- Keep all existing HTML sections unchanged -->
  <!-- Only modify the script part -->
  
  <script>
    // Sample car data to use when netlify functions fail
    const sampleCars = [
      {
        id: "sample1",
        make: "Toyota",
        model: "Corolla",
        year: "2023",
        price: "1850000",
        mileage: "5000",
        engine: "1800cc",
        transmission: "Automatic",
        fuel: "Petrol",
        colour: "White",
        features: "Alloy Wheels,Bluetooth,Backup Camera",
        images: "https://images.unsplash.com/photo-1541348263662-e068662d82af?q=80&w=1000&auto=format&fit=crop,https://images.unsplash.com/photo-1580273916550-e323be2ae537?q=80&w=1000&auto=format&fit=crop",
        isFeatured: true
      },
      {
        id: "sample2",
        make: "Honda",
        model: "CR-V",
        year: "2022",
        price: "3500000",
        mileage: "15000",
        engine: "2400cc",
        transmission: "Automatic",
        fuel: "Petrol",
        colour: "Silver",
        features: "Leather Seats,Sunroof,Navigation",
        images: "https://images.unsplash.com/photo-1606016159991-dfe4f2746ad5?q=80&w=1000&auto=format&fit=crop,https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?q=80&w=1000&auto=format&fit=crop",
        isFeatured: true
      },
      {
        id: "sample3",
        make: "Mazda",
        model: "CX-5",
        year: "2023",
        price: "3200000",
        mileage: "8000",
        engine: "2500cc",
        transmission: "Automatic",
        fuel: "Petrol",
        colour: "Red",
        features: "Bose Sound,LED Headlights,Lane Assist",
        images: "https://images.unsplash.com/photo-1563720223490-9d24e5e6a954?q=80&w=1000&auto=format&fit=crop,https://images.unsplash.com/photo-1562911791-c7a97b729ec5?q=80&w=1000&auto=format&fit=crop",
        isFeatured: true
      }
    ];

    // Function to create an image gallery for a car
    function createImageGallery(imageUrls, carName) {
      // If no images or just one image, return a simple image
      if (!imageUrls || imageUrls.length === 0) {
        return `<img src="https://images.unsplash.com/photo-1544636331-e26879cd4d9b" alt="No image available" class="w-full h-48 object-cover">`;
      }
      
      const images = imageUrls.split(',').map(url => url.trim()).filter(url => url);
      
      if (images.length === 1) {
        return `<img src="${images[0]}" alt="${carName}" class="w-full h-48 object-cover">`;
      }
      
      // Create gallery HTML
      const galleryHTML = `
        <div class="car-image-gallery" data-images="${images.length}">
          <div class="gallery-images">
            ${images.map(url => `<img src="${url}" alt="${carName}" class="gallery-image">`).join('')}
          </div>
          <div class="gallery-nav">
            <button class="gallery-btn prev-btn" aria-label="Previous image">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="gallery-btn next-btn" aria-label="Next image">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="gallery-indicators">
            ${images.map((_, i) => `<div class="indicator${i === 0 ? ' active' : ''}" data-index="${i}"></div>`).join('')}
          </div>
        </div>
      `;
      
      return galleryHTML;
    }

    // Function to initialize image galleries after DOM content is loaded
    function initImageGalleries() {
      document.querySelectorAll('.car-image-gallery').forEach(gallery => {
        const images = gallery.querySelector('.gallery-images');
        const prevBtn = gallery.querySelector('.prev-btn');
        const nextBtn = gallery.querySelector('.next-btn');
        const indicators = gallery.querySelectorAll('.indicator');
        const imageCount = parseInt(gallery.dataset.images, 10);
        let currentIndex = 0;
        
        // Function to update gallery
        function showImage(index) {
          // Ensure index is within bounds
          currentIndex = (index + imageCount) % imageCount;
          
          // Update transform to show the current image
          images.style.transform = `translateX(-${currentIndex * 100}%)`;
          
          // Update indicators
          indicators.forEach((indicator, i) => {
            indicator.classList.toggle('active', i === currentIndex);
          });
        }
        
        // Previous button click
        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showImage(currentIndex - 1);
        });
        
        // Next button click
        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showImage(currentIndex + 1);
        });
        
        // Indicator clicks
        indicators.forEach(indicator => {
          indicator.addEventListener('click', (e) => {
            e.stopPropagation();
            showImage(parseInt(indicator.dataset.index, 10));
          });
        });
      });
    }

    // Function to render car cards
    function renderCars(cars) {
      const featuredCarsContainer = document.getElementById('featuredCars');
      document.getElementById('featuredCarsLoadingSpinner').style.display = 'none';
      
      if (!cars || cars.length === 0) {
        featuredCarsContainer.innerHTML = `
          <div class="col-span-3 text-center py-12">
            <p class="text-gray-500">No cars available at this time. Please check back later.</p>
          </div>
        `;
        return;
      }
      
      // Clear the container
      featuredCarsContainer.innerHTML = '';
      
      // Limit to 6 cars
      const carsToShow = cars.slice(0, 6);
      
      // Loop through cars and create HTML for each
      carsToShow.forEach(car => {
        // Create card element
        const carCard = document.createElement('div');
        carCard.className = 'car-card bg-white rounded-lg shadow-lg overflow-hidden';
        
        // Add border
        carCard.classList.add('border-2', 'border-yellow-200');
        carCard.innerHTML = `
          <div class="bg-yellow-100 px-4 py-2">
            <span class="text-yellow-800 font-bold text-xs">${car.isFeatured ? 'FEATURED' : 'CAR'}</span>
          </div>
          ${createImageGallery(car.images, `${car.make} ${car.model}`)}
          <div class="p-6">
            <h3 class="text-xl font-bold font-poppins mb-2">${car.make} ${car.model}</h3>
            <p class="text-gray-600 mb-4">${car.colour || ''} ${car.features ? '• ' + car.features.split(',').slice(0, 2).join(' • ') : ''}</p>
            <p class="text-2xl font-bold text-blue-600">KSh ${parseInt(car.price).toLocaleString()}</p>
            <a href="cars.html" class="mt-4 block text-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">View Details</a>
          </div>
        `;
        
        // Add to the container
        featuredCarsContainer.appendChild(carCard);
      });
      
      // Initialize image galleries
      setTimeout(initImageGalleries, 100);
    }

    // Main function to load cars
    async function loadCars() {
      const featuredCarsContainer = document.getElementById('featuredCars');
      
      try {
        // Show loading spinner
        document.getElementById('featuredCarsLoadingSpinner').style.display = 'flex';
        
        // Set up timeout to handle slow connections
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timeout after 10 seconds')), 10000);
        });
        
        // Fetch car data from Netlify function with timeout
        const fetchPromise = fetch('/.netlify/functions/get-cars');
        
        // Race the fetch against a timeout
        const response = await Promise.race([fetchPromise, timeoutPromise]);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch car data: ${response.status}`);
        }
        
        const responseData = await response.json();
        const cars = responseData.cars || [];
        
        // Show all cars
        renderCars(cars);
        
      } catch (error) {
        console.error('Error fetching featured cars:', error);
        document.getElementById('featuredCarsLoadingSpinner').style.display = 'none';
        
        // Show error message and fallback to sample cars
        featuredCarsContainer.innerHTML = `
          <div class="col-span-3 text-center py-8">
            <p class="text-gray-500 mb-4">Unable to load cars from the server. Showing sample cars instead.</p>
            <button id="retryCarsLoad" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
              Retry
            </button>
          </div>
        `;
        
        // Add retry functionality
        document.getElementById('retryCarsLoad').addEventListener('click', function() {
          loadCars();
        });
        
        // Load sample cars as fallback
        setTimeout(() => {
          renderCars(sampleCars);
        }, 1000);
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', loadCars);
  </script>
</body>
</html>