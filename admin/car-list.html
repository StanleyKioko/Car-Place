<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car List - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #3b82f6;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
    }
    /* Toast message styles */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      border-radius: 4px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease;
      display: none;
    }
    .toast-success {
      background-color: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }
    .toast-error {
      background-color: #fee2e2;
      color: #b91c1c;
      border-left: 4px solid #ef4444;
    }
    /* Status badges */
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1.25rem;
    }
    .status-available {
      background-color: #d1fae5;
      color: #065f46;
    }
    .status-sold {
      background-color: #fecaca;
      color: #b91c1c;
    }
    .car-sold {
      opacity: 0.7;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-50">
    <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-blue-600 font-poppins">
     Admin
      </div>
      <div class="space-x-6">
        <a href="./index.html" class="text-gray-700 hover:text-blue-600">Dashboard</a>
        <a href="./add-car.html" class="text-gray-700 hover:text-blue-600">Add Car</a>
        <a href="./car-list.html" class="text-blue-600 font-semibold">Car List</a>
        <a href="../index.html" class="text-gray-700 hover:text-blue-600">Home</a>
      </div>
    </nav>
  </header>

  <!-- Page Header -->
  <section class="bg-blue-600 text-white py-8">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold font-poppins">All Cars</h1>
      <a href="./add-car.html" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100 transition">Add New Car</a>
    </div>
  </section>

  <!-- Car List Section -->
  <section class="container mx-auto px-4 py-8">
    <div class="flex justify-between mb-6">
      <div class="flex space-x-4">
        <input type="text" id="searchInput" placeholder="Search cars..." class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <select id="statusFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="all">All Cars</option>
          <option value="available">Available</option>
          <option value="sold">Sold</option>
        </select>
      </div>
      <a href="https://app.netlify.com/sites/blobecars/forms/car-submissions" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">View in Netlify</a>
    </div>
    
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Car</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Featured</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Added</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="carsList">
            <tr>
              <td colspan="8" class="px-6 py-4 text-center">
                <div class="flex justify-center">
                  <div class="spinner"></div>
                </div>
                <p class="mt-2 text-gray-500">Loading cars...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Status Change Modal -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-bold mb-4" id="statusModalTitle">Mark as Sold</h3>
      <p class="mb-6">Are you sure you want to mark <span id="carToUpdate" class="font-semibold"></span> as <span id="statusType" class="font-semibold"></span>?</p>
      <div class="flex justify-end space-x-4">
        <button id="cancelStatus" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancel</button>
        <button id="confirmStatus" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Message -->
  <div id="toast" class="toast">
    <span id="toastMessage"></span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const carsListTableBody = document.getElementById('carsList');
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const statusModal = document.getElementById('statusModal');
      const confirmStatus = document.getElementById('confirmStatus');
      const cancelStatus = document.getElementById('cancelStatus');
      const carToUpdate = document.getElementById('carToUpdate');
      const statusModalTitle = document.getElementById('statusModalTitle');
      const statusType = document.getElementById('statusType');
      
      let selectedCarId = null;
      let selectedCarName = '';
      let selectedStatus = '';
      let allCars = [];
      
      // Set up modal event handlers
      cancelStatus.addEventListener('click', closeStatusModal);
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        if (event.target === statusModal) {
          closeStatusModal();
        }
      });
      
      // Handle status change confirmation
      confirmStatus.addEventListener('click', async function() {
        if (selectedCarId && selectedStatus) {
          await updateCarStatus(selectedCarId, selectedStatus);
        }
      });
      
      // Load initial data
      await loadCarsData();
      
      // Apply filters when search input or status filter changes
      searchInput.addEventListener('input', applyFilters);
      statusFilter.addEventListener('change', applyFilters);
      
      // Function to apply all filters
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        
        const filteredCars = allCars.filter(car => {
          // Search filter
          const matchesSearch = 
            car.make?.toLowerCase().includes(searchTerm) ||
            car.model?.toLowerCase().includes(searchTerm) ||
            car.year?.toString().includes(searchTerm);
          
          // Status filter
          const matchesStatus = 
            statusValue === 'all' || 
            (statusValue === 'available' && !car.isSold) ||
            (statusValue === 'sold' && car.isSold);
          
          return matchesSearch && matchesStatus;
        });
        
        renderCars(filteredCars);
      }
      
      // Main function to load cars data
      async function loadCarsData() {
        try {
          const response = await fetch('/.netlify/functions/get-cars');
          
          if (!response.ok) {
            throw new Error('Failed to fetch car data');
          }
          
          const data = await response.json();
          allCars = data.cars || [];
          
          // Display all cars initially
          renderCars(allCars);
          
        } catch (error) {
          console.error('Error fetching cars:', error);
          carsListTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-red-500">
                Failed to load cars. Please try again later.
              </td>
            </tr>
          `;
        }
      }
      
      // Function to render cars table
      function renderCars(cars) {
        if (cars.length === 0) {
          carsListTableBody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                No cars found matching your search.
              </td>
            </tr>
          `;
          return;
        }
        
        carsListTableBody.innerHTML = '';
        
        // Sort cars by date added (newest first)
        const sortedCars = [...cars].sort((a, b) => 
          new Date(b.dateAdded || 0) - new Date(a.dateAdded || 0)
        );
        
        sortedCars.forEach(car => {
          // Get first image from comma-separated list
          const firstImage = car.images ? car.images.split(',')[0] : '../images/placeholder.jpg';
          
          const row = document.createElement('tr');
          // Add class if car is sold
          if (car.isSold) {
            row.classList.add('car-sold');
          }
          
          // Create image cell
          const imageCell = document.createElement('td');
          imageCell.className = 'px-6 py-4 whitespace-nowrap';
          const image = document.createElement('img');
          image.src = firstImage;
          image.alt = `${car.make} ${car.model}`;
          image.className = 'h-16 w-24 object-cover rounded';
          imageCell.appendChild(image);
          
          // Create car name cell
          const nameCell = document.createElement('td');
          nameCell.className = 'px-6 py-4 whitespace-nowrap';
          nameCell.innerHTML = `<div class="text-sm font-medium text-gray-900">${car.make} ${car.model}</div>
                               <div class="text-sm text-gray-500">${car.engine || ''} ${car.transmission || ''}</div>`;
          
          // Create year cell
          const yearCell = document.createElement('td');
          yearCell.className = 'px-6 py-4 whitespace-nowrap';
          yearCell.textContent = car.year;
          
          // Create price cell
          const priceCell = document.createElement('td');
          priceCell.className = 'px-6 py-4 whitespace-nowrap';
          priceCell.innerHTML = `<div class="text-sm font-medium text-gray-900">KSh ${parseInt(car.price).toLocaleString()}</div>`;
          
          // Create featured cell
          const featuredCell = document.createElement('td');
          featuredCell.className = 'px-6 py-4 whitespace-nowrap';
          featuredCell.innerHTML = car.isFeatured 
            ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>' 
            : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No</span>';
          
          // Create status cell
          const statusCell = document.createElement('td');
          statusCell.className = 'px-6 py-4 whitespace-nowrap';
          statusCell.innerHTML = car.isSold 
            ? '<span class="status-badge status-sold">Sold</span>' 
            : '<span class="status-badge status-available">Available</span>';
            
          // Create date cell
          const dateCell = document.createElement('td');
          dateCell.className = 'px-6 py-4 whitespace-nowrap';
          const date = car.dateAdded ? new Date(car.dateAdded).toLocaleDateString() : 'N/A';
          dateCell.textContent = date;
          
          // Create actions cell
          const actionsCell = document.createElement('td');
          actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
          
          const editLink = document.createElement('a');
          editLink.href = `./add-car.html?id=${car.id}`;
          editLink.className = 'text-blue-600 hover:text-blue-900 mr-3';
          editLink.textContent = 'Edit';
          
          const statusLink = document.createElement('a');
          statusLink.href = '#';
          
          // Set appropriate text and styling based on current status
          if (car.isSold) {
            statusLink.className = 'text-green-600 hover:text-green-900';
            statusLink.textContent = 'Mark Available';
            statusLink.dataset.status = 'available';
          } else {
            statusLink.className = 'text-red-600 hover:text-red-900';
            statusLink.textContent = 'Mark Sold';
            statusLink.dataset.status = 'sold';
          }
          
          statusLink.dataset.id = car.id;
          statusLink.dataset.name = `${car.make} ${car.model}`;
          
          // Add click handler for status change button
          statusLink.addEventListener('click', function(e) {
            e.preventDefault();
            selectedCarId = this.dataset.id;
            selectedCarName = this.dataset.name;
            selectedStatus = this.dataset.status;
            
            // Update modal content based on selected status
            if (selectedStatus === 'sold') {
              statusModalTitle.textContent = 'Mark as Sold';
              statusType.textContent = 'sold';
            } else {
              statusModalTitle.textContent = 'Mark as Available';
              statusType.textContent = 'available';
            }
            
            carToUpdate.textContent = selectedCarName;
            statusModal.style.display = 'block';
          });
          
          actionsCell.appendChild(editLink);
          actionsCell.appendChild(statusLink);
          
          // Append all cells to the row
          row.appendChild(imageCell);
          row.appendChild(nameCell);
          row.appendChild(yearCell);
          row.appendChild(priceCell);
          row.appendChild(featuredCell);
          row.appendChild(statusCell);
          row.appendChild(dateCell);
          row.appendChild(actionsCell);
          
          // Add row to the table
          carsListTableBody.appendChild(row);
        });
      }
      
      // Function to show status modal
      function showStatusModal(carName, status) {
        carToUpdate.textContent = carName;
        statusType.textContent = status;
        statusModal.style.display = 'block';
      }
      
      // Function to close status modal
      function closeStatusModal() {
        statusModal.style.display = 'none';
      }
      
      // Function to update car status
      async function updateCarStatus(carId, status) {
        try {
          // Show loading state
          confirmStatus.textContent = 'Updating...';
          confirmStatus.disabled = true;
          
          const response = await fetch('/.netlify/functions/update-car-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              id: carId, 
              isSold: status === 'sold' 
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to update car status');
          }
          
          // Close modal
          closeStatusModal();
          
          // Show success message
          const statusText = status === 'sold' ? 'sold' : 'available';
          showToast(`Car marked as ${statusText} successfully!`, 'success');
          
          // Update the local data
          const updatedCarIndex = allCars.findIndex(car => car.id === carId);
          if (updatedCarIndex !== -1) {
            allCars[updatedCarIndex].isSold = status === 'sold';
          }
          
          // Re-apply filters to update the display
          applyFilters();
          
        } catch (error) {
          console.error('Error updating car status:', error);
          showToast(`Error: ${error.message}`, 'error');
        } finally {
          // Reset button
          confirmStatus.textContent = 'Confirm';
          confirmStatus.disabled = false;
        }
      }
      
      // Show toast message
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }
    });
  </script>
</body>
</html>